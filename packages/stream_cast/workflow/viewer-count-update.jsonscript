{
  "version":"2.2.0","name":"Update Viewer Count","description":"Update and broadcast current viewer count","trigger":{"type":"scheduled","schedule":"*/30 * * * *"},"nodes":[{"id":"fetch_active_streams","type":"operation","op":"database_read","entity":"StreamChannel","params":{"filter":{"isLive":true}}},{"id":"update_viewer_counts","type":"operation","op":"parallel","tasks":[{"id":"count_viewers","op":"database_count","entity":"StreamSubscription","params":{"filter":{"channelId":"{{ $steps.fetch_active_streams.output.id }}"}}},{"id":"fetch_channel_stats","op":"database_read","entity":"StreamChannel","params":{"filter":{"id":"{{ $steps.fetch_active_streams.output.id }}"}}}]},{"id":"broadcast_counts","type":"action","action":"emit_event","event":"viewer_count_updated","channel":"{{ 'stream:' + $steps.fetch_active_streams.output.id }}","data":{"viewerCount":"{{ $steps.update_viewer_counts.tasks.count_viewers.output }}","liveTime":"{{ new Date() - new Date($steps.update_viewer_counts.tasks.fetch_channel_stats.output.startedAt) }}"}}]
}
