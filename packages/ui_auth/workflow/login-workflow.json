{
  "name": "Login Workflow",
  "active": false,
  "nodes": [
    {
      "id": "apply_rate_limit",
      "name": "Apply Rate Limit",
      "type": "metabuilder.rateLimit",
      "typeVersion": 1,
      "position": [
        100,
        100
      ],
      "parameters": {
        "name": "Apply Rate Limit",
        "typeVersion": 1,
        "position": [
          100,
          100
        ],
        "parameters": {
          "name": "Apply Rate Limit",
          "typeVersion": 1,
          "position": [
            100,
            100
          ],
          "parameters": {
            "operation": "rate_limit",
            "key": "{{ $json.email }}",
            "limit": 5,
            "window": 60000,
            "errorMessage": "Too many login attempts. Please try again in a few minutes."
          }
        }
      }
    },
    {
      "id": "validate_input",
      "name": "Validate Input",
      "type": "metabuilder.validate",
      "typeVersion": 1,
      "position": [
        400,
        100
      ],
      "parameters": {
        "name": "Validate Input",
        "typeVersion": 1,
        "position": [
          400,
          100
        ],
        "parameters": {
          "name": "Validate Input",
          "typeVersion": 1,
          "position": [
            400,
            100
          ],
          "parameters": {
            "input": "{{ $json }}",
            "operation": "validate",
            "rules": {
              "email": "required|email",
              "password": "required|string|minLength:6"
            }
          }
        }
      }
    },
    {
      "id": "fetch_user",
      "name": "Fetch User",
      "type": "metabuilder.database",
      "typeVersion": 1,
      "position": [
        700,
        100
      ],
      "parameters": {
        "name": "Fetch User",
        "typeVersion": 1,
        "position": [
          700,
          100
        ],
        "parameters": {
          "name": "Fetch User",
          "typeVersion": 1,
          "position": [
            700,
            100
          ],
          "parameters": {
            "filter": {
              "email": "{{ $json.email }}"
            },
            "operation": "database_read",
            "entity": "User"
          }
        }
      }
    },
    {
      "id": "check_user_exists",
      "name": "Check User Exists",
      "type": "metabuilder.condition",
      "typeVersion": 1,
      "position": [
        100,
        300
      ],
      "parameters": {
        "name": "Check User Exists",
        "typeVersion": 1,
        "position": [
          100,
          300
        ],
        "parameters": {
          "name": "Check User Exists",
          "typeVersion": 1,
          "position": [
            100,
            300
          ],
          "parameters": {
            "condition": "{{ $steps.fetch_user.output !== null }}",
            "operation": "condition"
          }
        }
      }
    },
    {
      "id": "verify_password",
      "name": "Verify Password",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        400,
        300
      ],
      "parameters": {
        "name": "Verify Password",
        "typeVersion": 1,
        "position": [
          400,
          300
        ],
        "parameters": {
          "name": "Verify Password",
          "typeVersion": 1,
          "position": [
            400,
            300
          ],
          "parameters": {
            "input": "{{ $json.password }}",
            "operation": "bcrypt_compare",
            "hash": "{{ $steps.fetch_user.output.passwordHash }}"
          }
        }
      }
    },
    {
      "id": "check_password_valid",
      "name": "Check Password Valid",
      "type": "metabuilder.condition",
      "typeVersion": 1,
      "position": [
        700,
        300
      ],
      "parameters": {
        "name": "Check Password Valid",
        "typeVersion": 1,
        "position": [
          700,
          300
        ],
        "parameters": {
          "name": "Check Password Valid",
          "typeVersion": 1,
          "position": [
            700,
            300
          ],
          "parameters": {
            "condition": "{{ $steps.verify_password.output === true }}",
            "operation": "condition"
          }
        }
      }
    },
    {
      "id": "check_account_active",
      "name": "Check Account Active",
      "type": "metabuilder.condition",
      "typeVersion": 1,
      "position": [
        100,
        500
      ],
      "parameters": {
        "name": "Check Account Active",
        "typeVersion": 1,
        "position": [
          100,
          500
        ],
        "parameters": {
          "name": "Check Account Active",
          "typeVersion": 1,
          "position": [
            100,
            500
          ],
          "parameters": {
            "condition": "{{ $steps.fetch_user.output.isActive !== false }}",
            "operation": "condition"
          }
        }
      }
    },
    {
      "id": "generate_session",
      "name": "Generate Session",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        400,
        500
      ],
      "parameters": {
        "name": "Generate Session",
        "typeVersion": 1,
        "position": [
          400,
          500
        ],
        "parameters": {
          "name": "Generate Session",
          "typeVersion": 1,
          "position": [
            400,
            500
          ],
          "parameters": {
            "operation": "generate_jwt",
            "payload": {
              "userId": "{{ $steps.fetch_user.output.id }}",
              "email": "{{ $steps.fetch_user.output.email }}",
              "tenantId": "{{ $steps.fetch_user.output.tenantId }}",
              "level": "{{ $steps.fetch_user.output.level }}"
            },
            "secret": "{{ $env.JWT_SECRET }}",
            "expiresIn": "24h"
          }
        }
      }
    },
    {
      "id": "create_session_record",
      "name": "Create Session Record",
      "type": "metabuilder.database",
      "typeVersion": 1,
      "position": [
        700,
        500
      ],
      "parameters": {
        "name": "Create Session Record",
        "typeVersion": 1,
        "position": [
          700,
          500
        ],
        "parameters": {
          "name": "Create Session Record",
          "typeVersion": 1,
          "position": [
            700,
            500
          ],
          "parameters": {
            "data": {
              "userId": "{{ $steps.fetch_user.output.id }}",
              "tenantId": "{{ $steps.fetch_user.output.tenantId }}",
              "token": "{{ $steps.generate_session.output }}",
              "ipAddress": "{{ $json.ipAddress }}",
              "userAgent": "{{ $json.userAgent }}",
              "expiresAt": "{{ new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() }}"
            },
            "operation": "database_create",
            "entity": "Session"
          }
        }
      }
    },
    {
      "id": "update_last_login",
      "name": "Update Last Login",
      "type": "metabuilder.database",
      "typeVersion": 1,
      "position": [
        100,
        700
      ],
      "parameters": {
        "name": "Update Last Login",
        "typeVersion": 1,
        "position": [
          100,
          700
        ],
        "parameters": {
          "name": "Update Last Login",
          "typeVersion": 1,
          "position": [
            100,
            700
          ],
          "parameters": {
            "filter": {
              "id": "{{ $steps.fetch_user.output.id }}"
            },
            "data": {
              "lastLogin": "{{ new Date().toISOString() }}"
            },
            "operation": "database_update",
            "entity": "User"
          }
        }
      }
    },
    {
      "id": "emit_login_event",
      "name": "Emit Login Event",
      "type": "metabuilder.action",
      "typeVersion": 1,
      "position": [
        400,
        700
      ],
      "parameters": {
        "name": "Emit Login Event",
        "typeVersion": 1,
        "position": [
          400,
          700
        ],
        "parameters": {
          "name": "Emit Login Event",
          "typeVersion": 1,
          "position": [
            400,
            700
          ],
          "parameters": {
            "data": {
              "userId": "{{ $steps.fetch_user.output.id }}",
              "tenantId": "{{ $steps.fetch_user.output.tenantId }}",
              "timestamp": "{{ new Date().toISOString() }}"
            },
            "action": "emit_event",
            "event": "user_login",
            "channel": "{{ 'user:' + $steps.fetch_user.output.id }}"
          }
        }
      }
    },
    {
      "id": "return_success",
      "name": "Return Success",
      "type": "metabuilder.action",
      "typeVersion": 1,
      "position": [
        700,
        700
      ],
      "parameters": {
        "name": "Return Success",
        "typeVersion": 1,
        "position": [
          700,
          700
        ],
        "parameters": {
          "name": "Return Success",
          "typeVersion": 1,
          "position": [
            700,
            700
          ],
          "parameters": {
            "action": "http_response",
            "status": 200,
            "body": {
              "token": "{{ $steps.generate_session.output }}",
              "user": {
                "id": "{{ $steps.fetch_user.output.id }}",
                "email": "{{ $steps.fetch_user.output.email }}",
                "displayName": "{{ $steps.fetch_user.output.displayName }}",
                "tenantId": "{{ $steps.fetch_user.output.tenantId }}"
              }
            }
          }
        }
      }
    }
  ],
  "connections": {},
  "staticData": {},
  "meta": {},
  "settings": {
    "timezone": "UTC",
    "executionTimeout": 3600,
    "saveExecutionProgress": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  }
}
