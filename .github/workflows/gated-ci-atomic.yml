name: Enterprise Gated CI/CD Pipeline (Atomic)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

# Enterprise Gated Tree Workflow with Atomic Steps
# Each validation tool runs as a separate step for better visualization
# Gate artifacts are persisted between stages using GitHub Actions artifacts
# Changes must pass through 5 gates before merge:
# Gate 1: Code Quality (lint, typecheck, security)
# Gate 2: Testing (unit, E2E)
# Gate 3: Build & Package
# Gate 4: Review & Approval
# Gate 5: Deployment (staging ‚Üí production with manual approval)

jobs:
  # ============================================================================
  # GATE 1: Code Quality Gates - Atomic Steps
  # ============================================================================
  
  gate-1-start:
    name: "Gate 1: Code Quality - Starting"
    runs-on: ubuntu-latest
    steps:
      - name: Gate 1 checkpoint
        run: |
          echo "üö¶ GATE 1: CODE QUALITY VALIDATION"
          echo "================================================"
          echo "Running atomic validation steps..."
          echo "Status: IN PROGRESS"
      
      - name: Create gate artifacts directory
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "started" > gate-artifacts/gate-1/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/start-time.txt
      
      - name: Upload gate start marker
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-start
          path: gate-artifacts/gate-1/

  # Atomic Step 1.1: Prisma Validation
  prisma-check:
    name: "Gate 1.1: Validate Prisma Schema"
    runs-on: ubuntu-latest
    needs: gate-1-start
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Validate Prisma Schema
        run: bunx prisma validate
        env:
          DATABASE_URL: file:./dev.db
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/prisma-check.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/prisma-check-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-prisma-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.2: TypeScript Check
  typecheck:
    name: "Gate 1.2: TypeScript Type Check"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Run TypeScript type check
        run: bun run typecheck
      
      - name: Run atomic TypeScript strict checker
        run: |
          cd ../..
          tsx tools/quality/code/check-typescript-strict.ts > gate-artifacts/typescript-strict.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/typecheck.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/typecheck-time.txt
          cp gate-artifacts/typescript-strict.json gate-artifacts/gate-1/ || true
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-typecheck-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.3: ESLint
  lint:
    name: "Gate 1.3: Lint Code"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Run ESLint
        run: bun run lint
      
      - name: Run atomic lint tools
        run: |
          mkdir -p ../../gate-artifacts/gate-1
          cd ../..
          
          # Find any types
          tsx tools/misc/lint/find-any-types.ts > gate-artifacts/gate-1/any-types.json || true
          
          # Find ts-ignore comments
          tsx tools/misc/lint/find-ts-ignores.ts > gate-artifacts/gate-1/ts-ignores.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/lint.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/lint-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-lint-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.4: Security Scan
  security-scan:
    name: "Gate 1.4: Security Scan"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run atomic security scanner
        run: |
          mkdir -p ../../gate-artifacts/gate-1
          cd ../..
          tsx tools/security/security-scanner.ts > gate-artifacts/gate-1/security-scan.json || true
        continue-on-error: true

      - name: Run dependency audit
        run: |
          bun audit --json > ../../gate-artifacts/gate-1/audit-results.json 2>&1 || true
          echo "Security audit completed"
        continue-on-error: true
      
      - name: Parse audit results
        run: |
          cd ../..
          tsx tools/misc/metrics/parse-npm-audit.ts gate-artifacts/gate-1/audit-results.json > gate-artifacts/gate-1/audit-summary.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/security-scan.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/security-scan-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-security-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.5: File Size Check
  file-size-check:
    name: "Gate 1.5: File Size Check"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run atomic file size checker
        run: |
          mkdir -p ../../gate-artifacts/gate-1
          cd ../..
          tsx tools/quality/files/check-file-sizes.ts > gate-artifacts/gate-1/file-sizes.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/file-size-check.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/file-size-check-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-filesize-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.6: Code Complexity Check
  code-complexity-check:
    name: "Gate 1.6: Code Complexity Check"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run atomic code complexity checker
        run: |
          mkdir -p ../../gate-artifacts/gate-1
          cd ../..
          tsx tools/quality/code/check-code-complexity.ts > gate-artifacts/gate-1/complexity.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/complexity-check.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/complexity-check-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-complexity-result
          path: gate-artifacts/gate-1/

  # Atomic Step 1.7: Stub Detection
  stub-detection:
    name: "Gate 1.7: Detect Stub Implementations"
    runs-on: ubuntu-latest
    needs: prisma-check
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run atomic stub detector
        run: |
          mkdir -p ../../gate-artifacts/gate-1
          cd ../..
          tsx tools/detection/detect-stub-implementations.ts > gate-artifacts/gate-1/stubs.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "${{ job.status }}" > gate-artifacts/gate-1/stub-detection.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/stub-detection-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-stub-result
          path: gate-artifacts/gate-1/

  gate-1-complete:
    name: "Gate 1: Code Quality - Passed ‚úÖ"
    runs-on: ubuntu-latest
    needs: [prisma-check, typecheck, lint, security-scan, file-size-check, code-complexity-check, stub-detection]
    steps:
      - name: Download all gate 1 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gate-1-*
          path: gate-artifacts/
          merge-multiple: true
      
      - name: Generate Gate 1 summary
        run: |
          echo "‚úÖ GATE 1 PASSED: CODE QUALITY"
          echo "================================================"
          echo "Atomic validation steps completed:"
          echo "‚úì 1.1 Prisma schema validated"
          echo "‚úì 1.2 TypeScript types checked"
          echo "‚úì 1.3 Code linted"
          echo "‚úì 1.4 Security scan completed"
          echo "‚úì 1.5 File sizes checked"
          echo "‚úì 1.6 Code complexity analyzed"
          echo "‚úì 1.7 Stub implementations detected"
          echo ""
          echo "Gate artifacts preserved for audit trail"
          echo "Proceeding to Gate 2: Testing..."
      
      - name: Create consolidated gate report
        run: |
          mkdir -p gate-artifacts/gate-1
          echo "completed" > gate-artifacts/gate-1/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-1/end-time.txt
          
          # List all validation results
          ls -la gate-artifacts/gate-1/ || true
      
      - name: Upload consolidated gate 1 report
        uses: actions/upload-artifact@v4
        with:
          name: gate-1-complete-report
          path: gate-artifacts/

  # ============================================================================
  # GATE 2: Testing Gates - Atomic Steps
  # ============================================================================

  gate-2-start:
    name: "Gate 2: Testing - Starting"
    runs-on: ubuntu-latest
    needs: gate-1-complete
    steps:
      - name: Gate 2 checkpoint
        run: |
          echo "üö¶ GATE 2: TESTING VALIDATION"
          echo "================================================"
          echo "Running atomic test steps..."
          echo "Status: IN PROGRESS"
      
      - name: Create gate artifacts directory
        run: |
          mkdir -p gate-artifacts/gate-2
          echo "started" > gate-artifacts/gate-2/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-2/start-time.txt
      
      - name: Upload gate start marker
        uses: actions/upload-artifact@v4
        with:
          name: gate-2-start
          path: gate-artifacts/gate-2/

  # Atomic Step 2.1: Unit Tests
  test-unit:
    name: "Gate 2.1: Unit Tests"
    runs-on: ubuntu-latest
    needs: gate-2-start
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Run unit tests
        run: bun run test:unit
        env:
          DATABASE_URL: file:./dev.db

      - name: Generate test coverage report
        run: |
          mkdir -p ../../gate-artifacts/gate-2
          cd ../..
          node tools/generation/generate-test-coverage-report.js > gate-artifacts/gate-2/coverage-report.json || true
        continue-on-error: true

      - name: Check function coverage
        run: |
          cd ../..
          node tools/quality/code/check-function-coverage.js > gate-artifacts/gate-2/function-coverage.json || true
        continue-on-error: true

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: frontends/nextjs/coverage/
          retention-days: 7
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-2
          echo "${{ job.status }}" > gate-artifacts/gate-2/test-unit.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-2/test-unit-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-2-unit-result
          path: gate-artifacts/gate-2/

  # Atomic Step 2.2: E2E Tests
  test-e2e:
    name: "Gate 2.2: E2E Tests"
    runs-on: ubuntu-latest
    needs: gate-2-start
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: bun run test:e2e
        env:
          DATABASE_URL: file:./dev.db

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontends/nextjs/playwright-report/
          retention-days: 7
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-2
          echo "${{ job.status }}" > gate-artifacts/gate-2/test-e2e.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-2/test-e2e-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-2-e2e-result
          path: gate-artifacts/gate-2/

  # Atomic Step 2.3: DBAL Daemon Tests
  test-dbal-daemon:
    name: "Gate 2.3: DBAL Daemon E2E"
    runs-on: ubuntu-latest
    needs: gate-2-start
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps chromium

      - name: Run DBAL daemon suite
        run: bun run test:e2e:dbal-daemon
        env:
          DATABASE_URL: file:./dev.db

      - name: Upload daemon test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-dbal-daemon
          path: frontends/nextjs/playwright-report/
          retention-days: 7
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-2
          echo "${{ job.status }}" > gate-artifacts/gate-2/test-dbal-daemon.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-2/test-dbal-daemon-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-2-dbal-result
          path: gate-artifacts/gate-2/

  gate-2-complete:
    name: "Gate 2: Testing - Passed ‚úÖ"
    runs-on: ubuntu-latest
    needs: [test-unit, test-e2e, test-dbal-daemon]
    steps:
      - name: Download all gate 2 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gate-2-*
          path: gate-artifacts/
          merge-multiple: true
      
      - name: Generate Gate 2 summary
        run: |
          echo "‚úÖ GATE 2 PASSED: TESTING"
          echo "================================================"
          echo "Atomic test steps completed:"
          echo "‚úì 2.1 Unit tests passed"
          echo "‚úì 2.2 E2E tests passed"
          echo "‚úì 2.3 DBAL daemon tests passed"
          echo ""
          echo "Gate artifacts preserved for audit trail"
          echo "Proceeding to Gate 3: Build & Package..."
      
      - name: Create consolidated gate report
        run: |
          mkdir -p gate-artifacts/gate-2
          echo "completed" > gate-artifacts/gate-2/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-2/end-time.txt
          ls -la gate-artifacts/gate-2/ || true
      
      - name: Upload consolidated gate 2 report
        uses: actions/upload-artifact@v4
        with:
          name: gate-2-complete-report
          path: gate-artifacts/

  # ============================================================================
  # GATE 3: Build & Package Gates - Atomic Steps
  # ============================================================================

  gate-3-start:
    name: "Gate 3: Build & Package - Starting"
    runs-on: ubuntu-latest
    needs: gate-2-complete
    steps:
      - name: Gate 3 checkpoint
        run: |
          echo "üö¶ GATE 3: BUILD & PACKAGE VALIDATION"
          echo "================================================"
          echo "Running atomic build steps..."
          echo "Status: IN PROGRESS"
      
      - name: Create gate artifacts directory
        run: |
          mkdir -p gate-artifacts/gate-3
          echo "started" > gate-artifacts/gate-3/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-3/start-time.txt
      
      - name: Upload gate start marker
        uses: actions/upload-artifact@v4
        with:
          name: gate-3-start
          path: gate-artifacts/gate-3/

  # Atomic Step 3.1: Build Application
  build:
    name: "Gate 3.1: Build Application"
    runs-on: ubuntu-latest
    needs: gate-3-start
    defaults:
      run:
        working-directory: frontends/nextjs
    outputs:
      build-success: ${{ steps.build-step.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Build
        id: build-step
        run: bun run build
        env:
          DATABASE_URL: file:./dev.db

      - name: Analyze bundle size
        run: |
          mkdir -p ../../gate-artifacts/gate-3
          cd ../..
          tsx tools/analysis/bundle/analyze-bundle-size.ts > gate-artifacts/gate-3/bundle-size.json || true
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: frontends/nextjs/.next/
          retention-days: 7
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-3
          echo "${{ job.status }}" > gate-artifacts/gate-3/build.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-3/build-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-3-build-result
          path: gate-artifacts/gate-3/

  # Atomic Step 3.2: Quality Metrics
  quality-check:
    name: "Gate 3.2: Code Quality Metrics"
    runs-on: ubuntu-latest
    needs: gate-3-start
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: frontends/nextjs
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: bun run db:generate
        env:
          DATABASE_URL: file:./dev.db

      - name: Check for console.log statements
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' | grep -E '^\+.*console\.(log|debug|info)'; then
            echo "‚ö†Ô∏è Found console.log statements in the changes"
            echo "Please remove console.log statements before merging"
            exit 1
          fi
        continue-on-error: true

      - name: Check for TODO comments
        run: |
          TODO_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' | grep -E '^\+.*TODO|FIXME' | wc -l)
          if [ $TODO_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è Found $TODO_COUNT TODO/FIXME comments in the changes"
            echo "Please address TODO comments before merging or create issues for them"
          fi
        continue-on-error: true
      
      - name: Generate quality summary
        run: |
          mkdir -p ../../gate-artifacts/gate-3
          cd ../..
          tsx tools/generation/generate-quality-summary.ts > gate-artifacts/gate-3/quality-summary.json || true
        continue-on-error: true
      
      - name: Record validation result
        if: always()
        run: |
          mkdir -p gate-artifacts/gate-3
          echo "${{ job.status }}" > gate-artifacts/gate-3/quality-check.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-3/quality-check-time.txt
      
      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-3-quality-result
          path: gate-artifacts/gate-3/

  gate-3-complete:
    name: "Gate 3: Build & Package - Passed ‚úÖ"
    runs-on: ubuntu-latest
    needs: [build, quality-check]
    if: always() && needs.build.result == 'success' && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped')
    steps:
      - name: Download all gate 3 artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gate-3-*
          path: gate-artifacts/
          merge-multiple: true
      
      - name: Generate Gate 3 summary
        run: |
          echo "‚úÖ GATE 3 PASSED: BUILD & PACKAGE"
          echo "================================================"
          echo "Atomic build steps completed:"
          echo "‚úì 3.1 Application built successfully"
          echo "‚úì 3.2 Quality metrics validated"
          echo ""
          echo "Gate artifacts preserved for audit trail"
          echo "Proceeding to Gate 4: Review & Approval..."
      
      - name: Create consolidated gate report
        run: |
          mkdir -p gate-artifacts/gate-3
          echo "completed" > gate-artifacts/gate-3/status.txt
          echo "$(date -Iseconds)" > gate-artifacts/gate-3/end-time.txt
          ls -la gate-artifacts/gate-3/ || true
      
      - name: Upload consolidated gate 3 report
        uses: actions/upload-artifact@v4
        with:
          name: gate-3-complete-report
          path: gate-artifacts/

  # ============================================================================
  # GATE 4: Review & Approval Gate (PR only)
  # ============================================================================

  gate-4-review-required:
    name: "Gate 4: Review & Approval Required"
    runs-on: ubuntu-latest
    needs: gate-3-complete
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR approval status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const latestReviews = {};
            for (const review of reviews) {
              latestReviews[review.user.login] = review.state;
            }
            
            const hasApproval = Object.values(latestReviews).includes('APPROVED');
            const hasRequestChanges = Object.values(latestReviews).includes('CHANGES_REQUESTED');
            
            console.log('Review Status:');
            console.log('==============');
            console.log('Approvals:', Object.values(latestReviews).filter(s => s === 'APPROVED').length);
            console.log('Change Requests:', Object.values(latestReviews).filter(s => s === 'CHANGES_REQUESTED').length);
            
            if (hasRequestChanges) {
              core.setFailed('‚ùå Changes requested - PR cannot proceed to deployment');
            } else if (!hasApproval) {
              core.notice('‚è≥ PR approval required before merge - this gate will pass when approved');
            } else {
              console.log('‚úÖ PR approved - gate passed');
            }

  gate-4-complete:
    name: "Gate 4: Review & Approval - Status"
    runs-on: ubuntu-latest
    needs: gate-4-review-required
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Gate 4 status
        run: |
          echo "üö¶ GATE 4: REVIEW & APPROVAL"
          echo "================================================"
          echo "Note: This gate requires human approval"
          echo "PR must be approved by reviewers before auto-merge"
          echo ""
          if [ "${{ needs.gate-4-review-required.result }}" == "success" ]; then
            echo "‚úÖ Review approval received"
            echo "Proceeding to Gate 5: Deployment (post-merge)..."
          else
            echo "‚è≥ Awaiting review approval"
            echo "Gate will complete when PR is approved"
          fi

  # ============================================================================
  # GATE 5: Deployment Gate (post-merge, main branch only)
  # ============================================================================

  gate-5-deployment-ready:
    name: "Gate 5: Deployment Ready"
    runs-on: ubuntu-latest
    needs: gate-3-complete
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Deployment gate checkpoint
        run: |
          echo "üö¶ GATE 5: DEPLOYMENT VALIDATION"
          echo "================================================"
          echo "Code merged to main branch"
          echo "Ready for staging deployment"
          echo ""
          echo "‚úÖ ALL GATES PASSED"
          echo "================================================"
          echo "‚úì Gate 1: Code Quality (7 atomic steps)"
          echo "‚úì Gate 2: Testing (3 atomic steps)"
          echo "‚úì Gate 3: Build & Package (2 atomic steps)"
          echo "‚úì Gate 4: Review & Approval"
          echo "‚úì Gate 5: Ready for Deployment"
          echo ""
          echo "Note: Production deployment requires manual approval"
          echo "Use workflow_dispatch with environment='production'"

  # ============================================================================
  # Summary Report with Gate Artifacts
  # ============================================================================

  gates-summary:
    name: "üéØ Gates Summary with Audit Trail"
    runs-on: ubuntu-latest
    needs: [gate-1-complete, gate-2-complete, gate-3-complete]
    if: always()
    steps:
      - name: Download all gate artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gate-*-complete-report
          path: all-gate-artifacts/
          merge-multiple: true
      
      - name: Generate comprehensive gates report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const gates = [
              { name: 'Gate 1: Code Quality (Atomic)', status: '${{ needs.gate-1-complete.result }}', steps: 7 },
              { name: 'Gate 2: Testing (Atomic)', status: '${{ needs.gate-2-complete.result }}', steps: 3 },
              { name: 'Gate 3: Build & Package (Atomic)', status: '${{ needs.gate-3-complete.result }}', steps: 2 }
            ];
            
            let summary = '## üö¶ Enterprise Gated CI/CD Pipeline Summary (Atomic)\n\n';
            summary += '### Gate Results\n\n';
            
            for (const gate of gates) {
              const icon = gate.status === 'success' ? '‚úÖ' : 
                          gate.status === 'failure' ? '‚ùå' : 
                          gate.status === 'skipped' ? '‚è≠Ô∏è' : '‚è≥';
              summary += `${icon} **${gate.name}**: ${gate.status} (${gate.steps} atomic steps)\n`;
            }
            
            summary += '\n### Atomic Step Visualization\n\n';
            summary += 'Each gate consists of individual atomic validation steps for better visibility:\n\n';
            summary += '**Gate 1 Steps:**\n';
            summary += '- 1.1 Prisma Validation\n';
            summary += '- 1.2 TypeScript Check\n';
            summary += '- 1.3 ESLint\n';
            summary += '- 1.4 Security Scan\n';
            summary += '- 1.5 File Size Check\n';
            summary += '- 1.6 Code Complexity\n';
            summary += '- 1.7 Stub Detection\n\n';
            
            summary += '**Gate 2 Steps:**\n';
            summary += '- 2.1 Unit Tests\n';
            summary += '- 2.2 E2E Tests\n';
            summary += '- 2.3 DBAL Daemon Tests\n\n';
            
            summary += '**Gate 3 Steps:**\n';
            summary += '- 3.1 Application Build\n';
            summary += '- 3.2 Quality Metrics\n\n';
            
            summary += '### Gate Artifacts\n\n';
            summary += 'All validation results are preserved as artifacts for audit trail:\n';
            summary += '- Security scan results\n';
            summary += '- Code complexity analysis\n';
            summary += '- Test coverage reports\n';
            summary += '- Bundle size analysis\n';
            summary += '- Quality metrics\n\n';
            
            if (context.eventName === 'pull_request') {
              summary += '### Next Steps\n';
              summary += '- ‚úÖ All CI gates passed with atomic validation\n';
              summary += '- ‚è≥ Awaiting PR approval (Gate 4)\n';
              summary += '- üìã Once approved, PR will auto-merge\n';
              summary += '- üöÄ Deployment gates (Gate 5) run after merge to main\n';
            }
            
            console.log(summary);
            
            // Post comment on PR if applicable
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
      
      - name: Upload complete audit trail
        uses: actions/upload-artifact@v4
        with:
          name: complete-gate-audit-trail
          path: all-gate-artifacts/
          retention-days: 30
