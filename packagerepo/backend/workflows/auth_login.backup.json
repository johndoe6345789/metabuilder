{
  "name": "Authenticate User",
  "description": "Login and generate JWT token",
  "version": "1.0.0",
  "nodes": [
    {
      "id": "parse_body",
      "type": "packagerepo.parse_json",
      "parameters": {
        "input": "$request.body",
        "out": "credentials"
      }
    },
    {
      "id": "validate_fields",
      "type": "logic.if",
      "parameters": {
        "condition": "$credentials.username == null || $credentials.password == null",
        "then": "error_invalid_request",
        "else": "verify_password"
      }
    },
    {
      "id": "verify_password",
      "type": "packagerepo.auth_verify_password",
      "parameters": {
        "username": "$credentials.username",
        "password": "$credentials.password",
        "out": "user"
      }
    },
    {
      "id": "check_verified",
      "type": "logic.if",
      "parameters": {
        "condition": "$user == null",
        "then": "error_unauthorized",
        "else": "generate_token"
      }
    },
    {
      "id": "generate_token",
      "type": "packagerepo.auth_generate_jwt",
      "parameters": {
        "subject": "$user.username",
        "scopes": "$user.scopes",
        "expires_in": 86400,
        "out": "token"
      }
    },
    {
      "id": "respond_success",
      "type": "packagerepo.respond_json",
      "parameters": {
        "body": {
          "ok": true,
          "token": "$token",
          "username": "$user.username",
          "scopes": "$user.scopes",
          "expires_in": 86400
        },
        "status": 200
      }
    },
    {
      "id": "error_invalid_request",
      "type": "packagerepo.respond_error",
      "parameters": {
        "message": "Missing username or password",
        "status": 400
      }
    },
    {
      "id": "error_unauthorized",
      "type": "packagerepo.respond_error",
      "parameters": {
        "message": "Invalid username or password",
        "status": 401
      }
    }
  ]
}
