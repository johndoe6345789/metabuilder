# Dovecot IMAP/POP3 Server Configuration
# Phase 8: Email Client Implementation
# Configuration for Docker container environment

##
## Core Settings
##

# Protocols to enable
protocols = imap pop3 lmtp

# Listen on all interfaces
listen = *, ::

# Log file location
log_path = /var/log/dovecot/dovecot.log
info_log_path = /var/log/dovecot/info.log
debug_log_path = /var/log/dovecot/debug.log

# Syslog facility
syslog_facility = mail

##
## Mail Storage Configuration
##

# Use Maildir format (one file per message)
mail_location = maildir:~/Maildir:LAYOUT=fs

# Mail user configuration
mail_uid = vmail
mail_gid = mail

# Privileged group for file access
mail_privileged_group = mail

# Home directory for virtual users
mail_home = /var/mail/%u

# Create missing directories automatically
mail_mkdir_parent = yes

# Maildir++ support for shared folders
namespace inbox {
  inbox = yes

  # Special mailbox configuration
  mailbox Drafts {
    special_use = \Drafts
    auto = subscribe
  }

  mailbox Sent {
    special_use = \Sent
    auto = subscribe
  }

  mailbox Spam {
    special_use = \Junk
    auto = subscribe
  }

  mailbox Trash {
    special_use = \Trash
    auto = subscribe
  }

  mailbox Archive {
    auto = no
  }
}

##
## IMAP Configuration
##

service imap {
  # Number of worker processes
  process_min_avail = 2

  # Maximum number of connections per process
  max_connections = 256
}

protocol imap {
  # Maximum message size (100 MB)
  mail_max_userip_connections = 10

  # Enable IMAP capabilities
  imap_idle_notify_interval = 2 mins

  # Compress support for bandwidth reduction
  imap_capability = +COMPRESS=DEFLATE
}

##
## POP3 Configuration
##

service pop3 {
  # Number of worker processes
  process_min_avail = 1
}

protocol pop3 {
  # POP3 capabilities
  pop3_uidl_format = %08Xu%08Xv

  # Allow POP3 clients to delete messages
  pop3_no_flag_updates = no
}

##
## LMTP Configuration (for Postfix integration)
##

service lmtp {
  unix_listener lmtp {
    mode = 0666
    user = vmail
    group = mail
  }
  process_min_avail = 1
}

protocol lmtp {
  # Enable mailbox autocreation via LMTP
  lmtp_save_to_detail_mailbox = yes
}

##
## SSL/TLS Configuration
##

ssl = required

# Certificate paths
ssl_cert = </etc/dovecot/certs/dovecot.crt
ssl_key = </etc/dovecot/private/dovecot.key

# TLS protocols (disable older insecure versions)
ssl_protocols = !SSLv2 !SSLv3 !TLSv1 !TLSv1.1

# Cipher suites
ssl_cipher_list = HIGH:!aNULL:!MD5:!eNULL:!EXP:!PSK:!SRP:!DSS

# Session resumption
ssl_prefer_server_ciphers = yes

# STARTTLS support
ssl_dh = </usr/share/dovecot/dh.pem

##
## Authentication Configuration
##

# Disable plaintext auth on non-secure connections
disable_plaintext_auth = yes

# Authentication methods
auth_mechanisms = plain login

# User database (static file-based)
userdb {
  driver = passwd-file
  args = username_format=%u /etc/dovecot/dovecot-users
}

# Password database (static file-based with SHA512-CRYPT)
passdb {
  driver = passwd-file
  args = username_format=%u scheme=SHA512-CRYPT /etc/dovecot/dovecot-users
}

# Master users (for migration/administration)
# Format: user:{SHA512-CRYPT}hash:admin
# master_users = root

# Allow root user for testing/administration (disable in production)
# skip_userdb_check = yes

##
## Service Configuration
##

service auth {
  unix_listener auth-userdb {
    mode = 0660
    user = vmail
    group = mail
  }

  unix_listener auth-client {
    mode = 0666
    user = dovecot
    group = dovecot
  }

  worker_max_count = 30
}

service auth-worker {
  user = vmail
}

service imap-login {
  inet_listener imap {
    port = 143
    address = *
  }

  inet_listener imaps {
    port = 993
    ssl = yes
    address = *
  }

  process_limit = 512
  process_min_avail = 2
  service_count = 1
  vsz_limit = 64 M
}

service pop3-login {
  inet_listener pop3 {
    port = 110
    address = *
  }

  inet_listener pop3s {
    port = 995
    ssl = yes
    address = *
  }

  process_limit = 512
}

##
## Performance Tuning
##

# Maximum number of concurrent processes
max_worker_processes = 512

# Process limits per protocol
default_process_limit = 100

# Virtual file system cache
mail_cache_fields = flags date.received date.sent size.virtual uid msgid mailbox-guid pop3-uidl
mail_always_cache_fields = flags date.received date.sent size.virtual

# Index files location
mail_server_comment = "Dovecot IMAP/POP3 Server"
mail_server_admin = "postmaster@emailclient.local"

##
## Logging Configuration
##

# Enable verbose logging for debugging
verbose_prolog = yes

# Log authentication attempts
auth_verbose = yes
auth_verbose_passwords = plain

# Log mail delivery
deliver_log_format = msgid=%m: %$
mail_log_enabled = yes

##
## Connection Rate Limiting
##

# Limit connections per IP
mail_max_userip_connections = 10

##
## Plugin Configuration
##

# Sieve mail filtering plugin
mail_plugins = $mail_plugins mail_log notify

protocol imap {
  mail_plugins = $mail_plugins imap_sieve
}

plugin {
  # Sieve settings
  sieve = file:~/sieve;active=~/.dovecot.sieve
  sieve_global_extensions = +vnd.dovecot.execute +vnd.dovecot.pipe +vnd.dovecot.filter
  sieve_max_redirects = 4

  # Mail log plugin
  mail_log_events = delete undelete expunge copy mailbox_delete mailbox_rename
  mail_log_fields = uid box msgid size
}

##
## Postfix Integration
##

# Enable Postfix LMTP delivery
service lmtp {
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    mode = 0660
    user = postfix
    group = postfix
  }
}

##
## Docker Environment Overrides
##

# Include local configuration from environment-specific settings
!include conf.d/??-*.conf
