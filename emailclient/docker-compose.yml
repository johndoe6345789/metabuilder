version: '3.8'

services:
  # SMTP Relay Service (Postfix)
  postfix:
    image: boky/postfix:latest
    container_name: emailclient-postfix
    environment:
      ALLOWED_SENDER_DOMAINS: 'example.com localhost'
      RELAYHOST: '[smtp.gmail.com]:587'
      RELAYHOST_USERNAME: ''
      RELAYHOST_PASSWORD: ''
      POSTFIX_myhostname: 'emailclient.local'
      POSTFIX_mynetworks: '127.0.0.0/8 10.0.0.0/8'
    ports:
      - '25:25'
      - '587:587'
    networks:
      - emailclient-net
    restart: unless-stopped

  # IMAP Server (Dovecot)
  dovecot:
    image: dovecot/dovecot:latest
    container_name: emailclient-dovecot
    environment:
      DOVECOT_PROTOCOLS: 'imap pop3'
      DOVECOT_MAIL_HOME: '/var/mail'
      DOVECOT_USER_DB: 'static'
      DOVECOT_PASS_DB: 'static'
    ports:
      - '143:143'
      - '993:993'
      - '110:110'
      - '995:995'
    volumes:
      - dovecot-data:/var/mail
      - ./config/dovecot.conf:/etc/dovecot/dovecot.conf:ro
    networks:
      - emailclient-net
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: emailclient-redis
    command: redis-server --appendonly yes
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
    networks:
      - emailclient-net
    restart: unless-stopped

  # Email Service (Flask backend)
  email-service:
    image: emailclient-service:latest
    build:
      context: ./services/email-service
      dockerfile: Dockerfile
    container_name: emailclient-email-service
    environment:
      POSTFIX_HOST: postfix
      DOVECOT_HOST: dovecot
      REDIS_URL: redis://redis:6379/0
      DATABASE_URL: postgresql://emailclient:emailclient@postgres:5432/emailclient
      FLASK_ENV: development
      FLASK_DEBUG: '1'
    ports:
      - '5000:5000'
    depends_on:
      - postfix
      - dovecot
      - redis
    networks:
      - emailclient-net
    restart: unless-stopped

  # PostgreSQL Database (optional, for email metadata)
  postgres:
    image: postgres:16-alpine
    container_name: emailclient-postgres
    environment:
      POSTGRES_USER: emailclient
      POSTGRES_PASSWORD: emailclient
      POSTGRES_DB: emailclient
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - emailclient-net
    restart: unless-stopped

volumes:
  dovecot-data:
  redis-data:
  postgres-data:

networks:
  emailclient-net:
    driver: bridge
